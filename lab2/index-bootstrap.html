<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const API_BASE_URL = "/items";
      let deleteItemId = null;
      let allItems = [];

      function renderTable(data) {
        let rows = data
          .map(
            (item) => `
              <tr data-id="${item.id}">
                <td>${item.id}</td>
                <td>${item.name}</td>
                <td>
                  <button class="btn btn-sm btn-primary me-2 edit-btn">Edit</button>
                  <button class="btn btn-sm btn-danger delete-btn">Delete</button>
                </td>
              </tr>
            `
          )
          .join("");

        document.querySelector("#itemsTable tbody").innerHTML = rows;

        document.querySelectorAll(".edit-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const row = e.target.closest("tr");
            document.querySelector("#itemId").value = row.dataset.id;
            document.querySelector("#itemName").value =
              row.children[1].innerText;

            new bootstrap.Modal(document.getElementById("itemModal")).show();
          });
        });

        document.querySelectorAll(".delete-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            deleteItemId = e.target.closest("tr").dataset.id;
            new bootstrap.Modal(document.getElementById("deleteModal")).show();
          });
        });
      }

      function loadItemsGETurl() {
        fetch(API_BASE_URL)
          .then((res) => res.json())
          .then((data) => {
            allItems = data;
            renderTable(allItems);
          });
      }

      function saveItem(event) {
        event.preventDefault(); // iMP or form is doing refressh

        const id = document.querySelector("#itemId").value;
        const name = document.querySelector("#itemName").value;

        const method = id ? "PUT" : "POST";
        const url = id ? `${API_BASE_URL}/${id}` : API_BASE_URL;

        fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name }),
        }).then(() => {
          loadItemsGETurl();
          document.querySelector("#itemForm").reset();
          bootstrap.Modal.getInstance(
            document.getElementById("itemModal")
          ).hide();
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadItemsGETurl();

        document.querySelector("#addItemBtn").addEventListener("click", () => {
          document.querySelector("#itemForm").reset();
          document.querySelector("#itemId").value = "";
          new bootstrap.Modal(document.getElementById("itemModal")).show();
        });

        document
          .querySelector("#itemForm")
          .addEventListener("submit", saveItem);

        document
          .querySelector("#confirmDeleteBtn")
          .addEventListener("click", () => {
            fetch(`${API_BASE_URL}/${deleteItemId}`, {
              method: "DELETE",
            }).then(() => {
              loadItemsGETurl();
              deleteItemId = null;
              bootstrap.Modal.getInstance(
                document.getElementById("deleteModal")
              ).hide();
            });
          });

        // search func
        document
          .querySelector("#searchInput")
          .addEventListener("input", (e) => {
            const val = e.target.value;
            const value = val.toLowerCase();
            const filteredItems = allItems.filter((item) =>
              item.name.toLowerCase().includes(value)
            );
            renderTable(filteredItems);
          });
      });
    </script>

    <title>Items inventory service</title>
  </head>

  <body>
    <nav class="navbar navbar-light bg-light">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">Items inventory service</span>
        <button class="btn btn-success" id="addItemBtn">+ AddItem</button>
      </div>
    </nav>

    <div class="container mt-4">
      <table class="table table-hover" id="itemsTable">
        <thead class="table-dark">
          <tr>
            <th>id</th>
            <th>name</th>
            <th>edit and delete btn</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- search bar at bottom | i tried to add -->
    <!-- https://coreui.io/bootstrap/docs/components/navbar/ -->
    <nav class="navbar bg-body-tertiary">
      <form class="container-fluid">
        <div class="input-group">
          <i class="bi bi-search-heart"></i>
          <input
            type="text"
            id="searchInput"
            class="form-control"
            placeholder="Search by name [caseinsensitive]"
            aria-label="Username"
            aria-describedby="basic-addon1"
          />
        </div>
      </form>
    </nav>

    <div class="modal fade" id="deleteModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">delete confirmation</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            Are you sure you want to deleette this item?
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="itemModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="itemForm">
            <div class="modal-header">
              <h5 class="modal-title">Item</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>

            <div class="modal-body">
              <input type="hidden" id="itemId" />
              <div class="mb-3">
                <label class="form-label">Item Name</label>
                <input
                  type="text"
                  id="itemName"
                  class="form-control"
                  required
                />
              </div>
            </div>

            <div class="modal-footer">
              <button type="submit" class="btn btn-primary">Save</button>
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </body>
</html>
